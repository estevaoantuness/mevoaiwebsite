name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ===========================================
  # Build e Lint
  # ===========================================
  build:
    name: Build & Validate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Check for syntax errors
        run: node --check server.js

  # ===========================================
  # Auditoria de SeguranÃ§a
  # ===========================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets in code..."

          # Patterns to look for
          PATTERNS=(
            'password\s*='
            'secret\s*='
            'api_key\s*='
            'apikey\s*='
            'auth_token\s*='
          )

          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            # Search in JS files, ignoring node_modules and .env references
            RESULTS=$(grep -rniE "$pattern" --include="*.js" --exclude-dir=node_modules . | grep -v "process.env" | grep -v ".env" || true)
            if [ -n "$RESULTS" ]; then
              echo "Potential secret found with pattern: $pattern"
              echo "$RESULTS"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "WARNING: Potential secrets found in code. Please review."
          else
            echo "No hardcoded secrets detected."
          fi

      - name: Check .env not committed
        run: |
          if [ -f ".env" ]; then
            echo "ERROR: .env file found in repository!"
            exit 1
          else
            echo ".env file correctly excluded from repository"
          fi

  # ===========================================
  # Tests (quando existirem)
  # ===========================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: mevo_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run tests
        run: npm test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/mevo_test
          JWT_SECRET: test-secret-key
          NODE_ENV: test

  # ===========================================
  # Deploy para Railway (apenas main)
  # ===========================================
  deploy:
    name: Deploy to Railway
    runs-on: ubuntu-latest
    needs: [build, security, test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Trigger Railway Deploy
        run: |
          if [ -n "${{ secrets.RAILWAY_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RAILWAY_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d '{"ref": "${{ github.sha }}"}'
            echo "Deploy triggered successfully"
          else
            echo "RAILWAY_WEBHOOK_URL not configured - skipping deploy"
          fi
        env:
          RAILWAY_WEBHOOK_URL: ${{ secrets.RAILWAY_WEBHOOK_URL }}
